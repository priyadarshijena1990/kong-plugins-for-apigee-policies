# SanitizeModelResponse Kong Plugin

## Purpose

The `SanitizeModelResponse` plugin for Kong Gateway is designed to clean, transform, and secure responses originating from upstream services, particularly those from AI/ML models. It allows you to modify the response body before it's sent to the client, enabling redaction of sensitive data, removal of unnecessary fields, filtering of content, and ensuring adherence to response size limits.

This plugin helps in maintaining data privacy, improving content quality, and optimizing response payloads.

## Abilities and Features

*   **JSON Response Processing**: Reads and parses the upstream response body as JSON (if applicable).
*   **Targeted Content Processing**: Can focus sanitization on a specific part of the JSON response defined by `response_source_jsonpath` or process the entire body.
*   **Sensitive Data Redaction**: Use `redact_fields` (JSON paths) to replace the values of specified fields with a configurable `redaction_string`.
*   **Field Removal**: Use `remove_fields` (JSON paths) to completely delete specified fields from the response.
*   **Regex-based Replacements**: Apply `replacements` (pattern/replacement pairs) to the response content (applied to the stringified version of the targeted content or the entire response).
*   **Response Truncation**: Set `max_length` to limit the size of the final response body.
*   **Graceful Non-JSON Handling**: Applies string replacements and truncation even if the upstream response is not a valid JSON.

<h2>Use Cases</h2>

*   **Data Masking/PII Protection**: Automatically redact or remove Personally Identifiable Information (PII), financial data, or other sensitive details generated by AI models.
*   **Content Filtering for AI/LLM Responses**: Filter out undesirable, harmful, or off-topic text from AI-generated content.
*   **Response Normalization**: Ensure model responses conform to a specific schema or remove internal metadata before reaching client applications.
*   **Cost Optimization**: Truncate overly long responses to save bandwidth or client processing.
*   **Security Post-Processing**: Remove potential vulnerabilities or unexpected content from model outputs.

<h2>Configuration</h2>

The plugin supports the following configuration parameters:

*   **`response_source_jsonpath`**: (string, default: `.`)
    A dot-notation JSON path pointing to the part of the response body to sanitize. If set to `.` (or empty), the entire response body is processed.
    *   Example: `results.0.text` to target the `text` field within the first item of a `results` array.
*   **`redact_fields`**: (array of strings, optional) A list of dot-notation JSON paths to fields whose values should be replaced by the `redaction_string`.
    *   Example: `user.email`, `credit_card_number`.
*   **`redaction_string`**: (string, default: `"[REDACTED]"`)
    The string used to replace the values of `redact_fields`.
*   **`remove_fields`**: (array of strings, optional) A list of dot-notation JSON paths to fields that should be completely removed from the response.
    *   Example: `internal_debug_info`, `raw_data`.
*   **`replacements`**: (array of records, optional) A list of regular expression `pattern` and `replacement` string pairs. These replacements are applied to the stringified version of the `response_source_jsonpath` content, or the entire response body if the path is `.`.
    *   Each record has: `pattern` (string, required, Lua/Nginx regex) and `replacement` (string, required).
*   **`max_length`**: (number, optional) If set, the final (sanitized and stringified) response body will be truncated to this maximum length if it exceeds it.

<h3>Example Configuration (via Admin API)</h3>

**Enable on a Service to redact sensitive user info and remove internal fields:**

```bash
curl -X POST http://localhost:8001/services/{service_id}/plugins \
    --data "name=sanitize-model-response" \
    --data "config.redact_fields=user.email" \
    --data "config.redact_fields=user.phone" \
    --data "config.redaction_string=[PRIVATE]" \
    --data "config.remove_fields=internal_tracking_id" \
    --data "config.remove_fields=model_weights"
```

**Enable on a Route to filter harmful language and truncate an AI-generated text field:**

```bash
curl -X POST http://localhost:8001/routes/{route_id}/plugins \
    --data "name=sanitize-model-response" \
    --data "config.response_source_jsonpath=generated_text" \
    --data "config.replacements.1.pattern=bad_word_1" \
    --data "config.replacements.1.replacement=****" \
    --data "config.replacements.2.pattern=bad_word_2" \
    --data "config.replacements.2.replacement=*****" \
    --data "config.max_length=500"
```

**Sanitizing the entire response body string for generic cleanup:**

```bash
curl -X POST http://localhost:8001/routes/{route_id}/plugins \
    --data "name=sanitize-model-response" \
    --data "config.response_source_jsonpath=." \
    --data "config.replacements.1.pattern=internal_api_key=\\w+" \
    --data "config.replacements.1.replacement=internal_api_key=[REDACTED]" \
    --data "config.max_length=1024"
```
